pipeline {
  agent any

  tools {
    maven 'Maven-Configured-In-Jenkins'  // Ensure this matches your Jenkins Maven tool name
  }

  stages {
    stage('Git Checkout') {
      steps {
        echo 'This stage clones the repo from GitHub'
        git branch: 'master', url: 'https://github.com/suman-123-git/star-agile-health-care.git'
      }
    }

    stage('Create Package') {
      steps {
        echo 'This stage compiles, tests, and packages the application'
        sh 'mvn clean package'
      }
    }

    stage('Generate Test Report') {
      steps {
        echo 'Generating Test Report using TestNG'
        publishHTML([allowMissing: true, alwaysLinkToLastBuild: false, keepAll: false, 
                     reportDir: 'target/surefire-reports', reportFiles: 'index.html', 
                     reportName: 'HTML Report'])
      }
    }

    stage('Create Docker Image') {
      steps {
        echo 'Building Docker image'
        sh 'docker build -t suman2000/healthcare:1.0 .'
      }
    }

    stage('Login to Docker Hub') {
      steps {
        echo 'Logging into Docker Hub'
        withCredentials([usernamePassword(credentialsId: 'dockerloginnew', 
                                          passwordVariable: 'dockerpass', 
                                          usernameVariable: 'dockeruser')]) {
          sh 'echo ${dockerpass} | docker login -u ${dockeruser} --password-stdin'
        }
      }
    }

    stage('Push Docker Image') {
      steps {
        echo 'Pushing Docker image to Docker Hub'
        sh 'docker push suman2000/healthcare:1.0'
      }
    }
  }

  post {
    always {
      echo 'Cleaning workspace after build'
      cleanWs()
    }
  }
}
